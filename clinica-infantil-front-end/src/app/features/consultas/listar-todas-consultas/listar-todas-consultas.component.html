<div class="dashboard container my-5">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h1 class="fw-bold mb-0">Todas Consultas</h1>
    @if (isAdministradorRoute) {
      <a [routerLink]="['./agendar']" class="btn btn-success fw-bold d-flex align-items-center">
        <i class="bi bi-plus-lg me-2"></i> Agendar Nova Consulta
      </a>
    } @else {
      <a [routerLink]="['../agendar']" class="btn btn-success fw-bold d-flex align-items-center">
        <i class="bi bi-plus-lg me-2"></i> Agendar Nova Consulta
      </a>
    }
  </div>

  @if (isLoading) {
    <div class="alert alert-info mt-3">Carregando consultas...</div>
  }

  @if (error) {
    <div class="alert alert-danger mt-3">{{ error }}</div>
  }

  @if (successMessage) {
    <div class="alert alert-success mt-3">{{ successMessage }}</div>
  }

  <div class="row">
    <div class="col-12">
      @if (!isLoading && !error && consultas.length > 0) {
        <div class="table-responsive">
          <table class="table table-striped mt-3 table-hover">
            <thead class="table-dark">
              <tr>
                <th class="d-none d-lg-table-cell">ID</th>
                <th>Paciente</th>
                <th class="d-none d-md-table-cell">Médico</th>
                <th class="d-none d-lg-table-cell">Especialidade</th>
                <th class="d-none d-md-table-cell">Data</th>
                <th class="d-none d-lg-table-cell">Início</th>
                <th class="d-none d-lg-table-cell">Fim</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (consulta of consultas; track consulta.id; let i = $index) {
                <tr>
                  <td class="d-none d-lg-table-cell">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                  <td>{{ consulta.paciente.cliente.nome }}</td>
                  <td class="d-none d-md-table-cell">{{ consulta.medico.usuario.funcionario.nome }}</td>
                  <td class="d-none d-lg-table-cell">{{ consulta.medico.especialidade }}</td>
                  <td class="d-none d-md-table-cell">{{ consulta.data_consulta | date:'dd/MM/yyyy' }}</td>
                  <td class="d-none d-lg-table-cell">{{ consulta.hora_inicio | slice:0:5 }}</td>
                  <td class="d-none d-lg-table-cell">{{ consulta.hora_fim | slice:0:5 }}</td>
                  <td>
                    <span class="badge rounded-pill text-uppercase p-2" [ngClass]="{
                      'bg-warning text-dark': consulta.status === 'agendada',
                      'bg-success': consulta.status === 'concluida',
                      'bg-danger': consulta.status === 'cancelada',
                      'bg-dark': consulta.status === 'finalizada'
                    }">
                      {{ consulta.status }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex flex-wrap gap-2">
                      <a class="btn btn-info btn-sm" [routerLink]="[ consulta.id]" title="Ver Detalhes">
                        <i class="bi bi-info-circle"></i>
                      </a>
                      @if (isAdministradorRoute) {
                        @if (consulta.status === 'agendada' || consulta.status === 'concluida') {
                          @if (consulta.status === 'concluida') {
                            <a class="btn btn-success btn-sm" [routerLink]="['/administrador/consultas', consulta.id, 'finalizar']" title="Finalizar Consulta">
                              <i class="bi bi-clipboard2-check"></i>
                            </a>
                          } @else if (consulta.status === 'agendada') {
                            <a class="btn btn-warning btn-sm" [routerLink]="['/administrador/consultas', consulta.id, 'remarcar']" title="Remarcar Consulta">
                              <i class="bi bi-pencil"></i>
                            </a>
                            <button class="btn btn-danger btn-sm" (click)="openCancelModal(consulta.id)" title="Cancelar Consulta">
                              <i class="bi bi-calendar-x"></i>
                            </button>
                          }
                        }
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Paginação e Contador -->
        @if (pagination && pagination.links.length > 0) {
          <nav aria-label="Navegação da tabela de consultas" class="mt-4">
            <ul class="pagination justify-content-center flex-wrap">
              @for (link of pagination.links; track $index) {
                <li class="page-item" [ngClass]="{'active': link.active, 'disabled': !link.url}">
                  <button
                    type="button"
                    class="page-link"
                    (click)="onPageChange(link.url)"
                    [disabled]="!link.url">
                    @if (link.label === '&laquo; Previous') {
                      <span aria-hidden="true">&laquo; Anterior</span>
                    } @else if (link.label === 'Next &raquo;') {
                      <span aria-hidden="true">Próximo &raquo;</span>
                    } @else {
                      {{ link.label }}
                    }
                  </button>
                </li>
              }
            </ul>
            <div class="text-center mt-2">
              Página {{ pagination.current_page }} de {{ pagination.last_page }} (Total: {{ pagination.total }} consultas)
            </div>
          </nav>
        }
      } @else if (!isLoading && !error) {
        <div class="alert alert-warning mt-3 text-center">Nenhuma consulta encontrada.</div>
      }
    </div>
  </div>

  <div class="mt-4">
    @if (isSecretariaRoute) {
      <app-botao-voltar texto="Voltar para o Dashboard" routerLink="../"></app-botao-voltar>
    } @else {
      <app-botao-voltar texto="Voltar para o Dashboard" routerLink="../"></app-botao-voltar>
    }
  </div>

  <!-- Modal de Confirmação de Cancelamento -->
  @if (showCancelModal) {
    <div class="modal d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirmar Cancelamento</h5>
            <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="closeCancelModal()"></button>
          </div>
          <div class="modal-body">
            <p>Tem certeza que deseja cancelar esta consulta? Esta ação não pode ser desfeita.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeCancelModal()">Não</button>
            <button type="button" class="btn btn-danger" (click)="confirmCancel()">Sim, Cancelar</button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
